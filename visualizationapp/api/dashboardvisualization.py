import re
from datetime import *
from rest_framework import status
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import permissions

from patientapp.models import Patient

from rest_framework import filters
from userapp.models import User, CustomUser
import os
from django.http import JsonResponse
from treatmentapp.models import Treatment
from encounterapp.models import Screeing, Encounter, Refer

from nepali.datetime import NepaliDate
from django.db.models import DurationField, F, ExpressionWrapper
import datetime
from django.db.models import Q

from visualizationapp.models import Visualization
from addressapp.models import Activity

from visualizationapp.serializers.visualization import OverViewVisualization

from visualizationapp.serializers.visualization import TreatMentBarGraphVisualization,ActivityDistributionVisualization
from addressapp.models import Address, District, Municipality, Ward
from django.db.models import Sum
import logging

# Get an instance of a logger
from django.db.models import Count, Case, When, Value

logger = logging.getLogger(__name__)


np_date = NepaliDate()
# d=datetime.date(np_date.npYear(),np_date.npMonth(),np_date.npDay())
# lessthan18 = d - datetime.timedelta(days=365*18)
# greaterthan60 = d - datetime.timedelta(days=365*60)


today_date = datetime.date.today()
last_30_days = datetime.date.today() + datetime.timedelta(-30)

today_date_obj = str(NepaliDate.from_date(today_date))
last_30_days_obj = str(NepaliDate.from_date(last_30_days))


class IsPostOrIsAuthenticated(permissions.BasePermission):
    def has_permission(self, request, view):
        return request.user and request.user.is_authenticated


# 1.2 Treatment Distribution
class TreatmentDistributionAPI(APIView):
    permission_classes = (IsPostOrIsAuthenticated,)
    serializer_class = TreatMentBarGraphVisualization


    def get(self, request, format=None):
        if User.objects.get(id=request.user.id):
            district = ["Child", "Teen", "Adult", "Old Adult"]
            kid_exo = Visualization.objects.filter(active=True,
                age__lt=13, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("exo"))["exo__sum"]
            if kid_exo is None:
                kid_exo = 0
            kid_art = Visualization.objects.filter(active=True,
                age__lt=13, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("art"))["art__sum"]
            if kid_art is None:
                kid_art = 0
            kid_seal = Visualization.objects.filter(active=True,
                age__lt=13, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("seal"))["seal__sum"]
            if kid_seal is None:
                kid_seal = 0
            kid_sdf = Visualization.objects.filter(active=True,
                age__lt=13, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("sdf"))["sdf__sum"]
            if kid_sdf is None:
                kid_sdf = 0
            kid_fv = Visualization.objects.filter(active=True,
                fv=True,
                age__lt=13,
                created_at__range=[last_30_days_obj, today_date_obj],
            ).count()

            teen_exo = Visualization.objects.filter(active=True,
                age__range=(13, 18),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("exo"))["exo__sum"]
            if teen_exo is None:
                teen_exo = 0
            teen_art = Visualization.objects.filter(active=True,
                age__range=(13, 18),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("art"))["art__sum"]
            if teen_art is None:
                teen_art = 0
            teen_seal = Visualization.objects.filter(active=True,
                age__range=(13, 18),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("seal"))["seal__sum"]
            if teen_seal is None:
                teen_seal = 0
            teen_sdf = Visualization.objects.filter(active=True,
                age__range=(13, 18),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("sdf"))["sdf__sum"]
            if teen_sdf is None:
                teen_sdf = 0
            teen_fv = Visualization.objects.filter(active=True,
                fv=True,
                age__range=(13, 18),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).count()

            adult_exo = Visualization.objects.filter(active=True,
                age__range=(19, 60),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("exo"))["exo__sum"]
            if adult_exo is None:
                adult_exo = 0
            adult_art = Visualization.objects.filter(active=True,
                age__range=(19, 60),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("art"))["art__sum"]
            if adult_art is None:
                adult_art = 0
            adult_seal = Visualization.objects.filter(active=True,
                age__range=(19, 60),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("seal"))["seal__sum"]
            if adult_seal is None:
                adult_seal = 0
            adult_sdf = Visualization.objects.filter(active=True,
                age__range=(19, 60),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).aggregate(Sum("sdf"))["sdf__sum"]
            if adult_sdf is None:
                adult_sdf = 0
            adult_fv = Visualization.objects.filter(active=True,
                fv=True,
                age__range=(19, 60),
                created_at__range=[last_30_days_obj, today_date_obj],
            ).count()

            old_adult_exo = Visualization.objects.filter(active=True,
                age__gt=60, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("exo"))["exo__sum"]
            if old_adult_exo is None:
                old_adult_exo = 0
            old_adult_art = Visualization.objects.filter(active=True,
                age__gt=60, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("art"))["art__sum"]
            if old_adult_art is None:
                old_adult_art = 0
            old_adult_seal = Visualization.objects.filter(active=True,
                age__gt=60, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("seal"))["seal__sum"]
            if old_adult_seal is None:
                old_adult_seal = 0
            old_adult_sdf = Visualization.objects.filter(active=True,
                age__gt=60, created_at__range=[last_30_days_obj, today_date_obj]
            ).aggregate(Sum("sdf"))["sdf__sum"]
            if old_adult_sdf is None:
                old_adult_sdf = 0
            old_adult_fv = Visualization.objects.filter(active=True,
                fv=True,
                age__gt=60,
                created_at__range=[last_30_days_obj, today_date_obj],
            ).count()

            exo_data = [kid_exo, teen_exo, adult_exo, old_adult_exo]
            fv_data = [kid_fv, teen_fv, adult_fv, old_adult_fv]
            art_data = [kid_art, teen_art, adult_art, old_adult_art]
            seal_data = [kid_seal, teen_seal, adult_seal, old_adult_seal]
            sdf_data = [kid_sdf, teen_sdf, adult_sdf, old_adult_sdf]

            locationChart = {
                "data": {
                    "labels": district,
                    "datasets": [
                        {
                            "label": "EXO",
                            "backgroundColor": "rgba(255, 206, 86, 0.2)",
                            "borderColor": "rgba(255, 206, 86, 1)",
                            "borderWidth": 1,
                            "data": exo_data,
                        },
                        {
                            "label": "ART",
                            "backgroundColor": "rgba(81, 264, 210, 0.2)",
                            "borderColor": "rgba(81, 264, 210, 1)",
                            "borderWidth": 1,
                            "data": art_data,
                        },
                        {
                            "label": "SEAL",
                            "backgroundColor": "rgba(16, 152, 247, 0.2)",
                            "borderColor": "rgba(16, 152, 247, 1)",
                            "borderWidth": 1,
                            "data": seal_data,
                        },
                        {
                            "label": "SDF",
                            "backgroundColor": "rgba(87, 50, 200, 0.2)",
                            "borderColor": "rgba(87, 50, 200, 1)",
                            "borderWidth": 1,
                            "data": sdf_data,
                        },

                        {
                            "label": "FV",
                            "backgroundColor": "rgba(239, 62, 54, 0.2)",
                            "borderColor": "rgba(239, 62, 54, 1)",
                            "borderWidth": 1,
                            "data": fv_data,
                        },
                        
                    ],
                },
                "options": {
                    "aspectRatio": 1.5,
                    "scales": {"yAxes": [{"ticks": {"beginAtZero": "true"}}]},
                    "title": {
                        "display": "true",
                        # 'text': "Setting-wise treatment distribution",
                        "fontSize": 18,
                        "fontFamily": "'Palanquin', sans-serif",
                    },
                    "legend": {
                        "display": "true",
                        "position": "bottom",
                        "labels": {
                            "usePointStyle": "true",
                            "padding": 20,
                            "fontFamily": "'Maven Pro', sans-serif",
                        },
                    },
                },
            }
            return Response({"locationChart": locationChart})
        return Response({"message": "only admin can create"}, status=400)

    def post(self, request, format=None):
        serializer = TreatMentBarGraphVisualization(
            data=request.data, context={"request": request}
        )
        if serializer.is_valid():
            start_date = str(NepaliDate.from_date(serializer.validated_data["start_date"]))
            end_date = str(NepaliDate.from_date(serializer.validated_data["end_date"]))
            location_list = serializer.validated_data["location"]

            district = [
                "Community Outreach",
                "Health Post",
                "School Seminar",
                "Training",
            ]

            district1 = ["Child", "Teen", "Adult", "Old Adult"]

            health_post_obj = Activity.objects.get(name="Health Post")
            seminar_obj = Activity.objects.get(name="School Seminar")
            outreach_obj = Activity.objects.get(name="Community Outreach")
            training = Activity.objects.get(name="Training")
            age_group_activity = serializer.validated_data["age_group_activity"]

            health_post_exo = []
            health_post_art = []
            health_post_seal = []
            health_post_sdf = []
            health_post_fv = []

            seminar_exo = []
            seminar_art = []
            seminar_seal = []
            seminar_sdf = []
            seminar_fv = []

            outreach_exo = []
            outreach_art = []
            outreach_seal = []
            outreach_sdf = []
            outreach_fv = []

            training_exo = []
            training_art = []
            training_seal = []
            training_sdf = []
            training_fv = []

            kid_exo = []
            kid_art = []
            kid_seal = []
            kid_sdf = []
            kid_fv = []

            teen_exo = []
            teen_art = []
            teen_seal = []
            teen_sdf = []
            teen_fv = []

            adult_exo = []
            adult_art = []
            adult_seal = []
            adult_sdf = []
            adult_fv = []

            old_adult_exo = []
            old_adult_art = []
            old_adult_seal = []
            old_adult_sdf = []
            old_adult_fv = []
            
            for location in location_list:
                if (
                    Visualization.objects.filter(active=True,activities_id=health_post_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    health_post_exo.append(
                        Visualization.objects.filter(active=True,
                            activities_id=health_post_obj.id
                        )
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    health_post_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=health_post_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    health_post_art.append(
                        Visualization.objects.filter(active=True,
                            activities_id=health_post_obj.id
                        )
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    health_post_art.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=health_post_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    health_post_seal.append(
                        Visualization.objects.filter(active=True,
                            activities_id=health_post_obj.id
                        )
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    health_post_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=health_post_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    health_post_sdf.append(
                        Visualization.objects.filter(active=True,
                            activities_id=health_post_obj.id
                        )
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    health_post_sdf.append(0)
                health_post_fv.append(
                    Visualization.objects.filter(active=True,
                        fv=True, activities_id=health_post_obj.id
                    )
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )

                if (
                    Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    seminar_exo.append(
                        Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    seminar_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    seminar_art.append(
                        Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    seminar_art.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    seminar_seal.append(
                        Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    seminar_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    seminar_sdf.append(
                        Visualization.objects.filter(active=True,activities_id=seminar_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    seminar_sdf.append(0)
                seminar_fv.append(
                    Visualization.objects.filter(active=True,
                        fv=True, activities_id=seminar_obj.id
                    )
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )

                if (
                    Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    outreach_exo.append(
                        Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    outreach_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    outreach_art.append(
                        Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    outreach_art.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    outreach_seal.append(
                        Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    outreach_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    outreach_sdf.append(
                        Visualization.objects.filter(active=True,activities_id=outreach_obj.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    outreach_sdf.append(0)
                outreach_fv.append(
                    Visualization.objects.filter(active=True,
                        fv=True, activities_id=outreach_obj.id
                    )
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )

                if (
                    Visualization.objects.filter(active=True,activities_id=training.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    training_exo.append(
                        Visualization.objects.filter(active=True,activities_id=training.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    training_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=training.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    training_art.append(
                        Visualization.objects.filter(active=True,activities_id=training.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    training_art.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=training.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    training_seal.append(
                        Visualization.objects.filter(active=True,activities_id=training.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    training_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,activities_id=training.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    training_sdf.append(
                        Visualization.objects.filter(active=True,activities_id=training.id)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    training_sdf.append(0)
                training_fv.append(
                    Visualization.objects.filter(active=True,fv=True, activities_id=training.id)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )

                if (
                    Visualization.objects.filter(active=True,age__lt=12)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    kid_exo.append(
                        Visualization.objects.filter(active=True,age__lt=12)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    kid_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,age__lt=12)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    kid_art.append(
                        Visualization.objects.filter(active=True,age__lt=12)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    kid_art.append(0)

                if (
                    Visualization.objects.filter(active=True,age__lt=12)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    kid_seal.append(
                        Visualization.objects.filter(active=True,age__lt=12)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    kid_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,age__lt=12)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    kid_sdf.append(
                        Visualization.objects.filter(active=True,age__lt=12)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    kid_sdf.append(0)
                kid_fv.append(
                    Visualization.objects.filter(active=True,fv=True, age__lt=12)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )

                if (
                    Visualization.objects.filter(active=True,age__range=(12, 18))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    teen_exo.append(
                        Visualization.objects.filter(active=True,age__range=(12, 18))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    teen_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,age__range=(12, 18))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    teen_art.append(
                        Visualization.objects.filter(active=True,age__range=(12, 18))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    teen_art.append(0)

                if (
                    Visualization.objects.filter(active=True,age__range=(12, 18))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    teen_seal.append(
                        Visualization.objects.filter(active=True,age__range=(12, 18))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    teen_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,age__range=(12, 18))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    teen_sdf.append(
                        Visualization.objects.filter(active=True,age__range=(12, 18))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    teen_sdf.append(0)
                teen_fv.append(
                    Visualization.objects.filter(active=True,fv=True, age__range=(12, 18))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )

                if (
                    Visualization.objects.filter(active=True,age__range=(19, 60))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    adult_exo.append(
                        Visualization.objects.filter(active=True,age__range=(19, 60))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    adult_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,age__range=(19, 60))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    adult_art.append(
                        Visualization.objects.filter(active=True,age__range=(19, 60))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    adult_art.append(0)

                if (
                    Visualization.objects.filter(active=True,age__range=(19, 60))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    adult_seal.append(
                        Visualization.objects.filter(active=True,age__range=(19, 60))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    adult_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,age__range=(19, 60))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    adult_sdf.append(
                        Visualization.objects.filter(active=True,age__range=(19, 60))
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    adult_sdf.append(0)
                adult_fv.append(
                    Visualization.objects.filter(active=True,fv=True, age__range=(19, 60))
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )

                if (
                    Visualization.objects.filter(active=True,age__gt=60)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("exo"))["exo__sum"]
                    is not None
                ):
                    old_adult_exo.append(
                        Visualization.objects.filter(active=True,age__gt=60)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("exo"))["exo__sum"]
                    )
                else:
                    old_adult_exo.append(0)

                if (
                    Visualization.objects.filter(active=True,age__gt=60)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("art"))["art__sum"]
                    is not None
                ):
                    old_adult_art.append(
                        Visualization.objects.filter(active=True,age__gt=60)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("art"))["art__sum"]
                    )
                else:
                    old_adult_art.append(0)

                if (
                    Visualization.objects.filter(active=True,age__gt=60)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("seal"))["seal__sum"]
                    is not None
                ):
                    old_adult_seal.append(
                        Visualization.objects.filter(active=True,age__gt=60)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("seal"))["seal__sum"]
                    )
                else:
                    old_adult_seal.append(0)

                if (
                    Visualization.objects.filter(active=True,age__gt=60)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .aggregate(Sum("sdf"))["sdf__sum"]
                    is not None
                ):
                    old_adult_sdf.append(
                        Visualization.objects.filter(active=True,age__gt=60)
                        .filter(
                            created_at__range=[start_date, end_date],
                            geography_id=location.id,
                        )
                        .aggregate(Sum("sdf"))["sdf__sum"]
                    )
                else:
                    old_adult_sdf.append(0)
                old_adult_fv.append(
                    Visualization.objects.filter(active=True,fv=True, age__gt=60)
                    .filter(
                        created_at__range=[start_date, end_date],
                        geography_id=location.id,
                    )
                    .count()
                )
            exo_data = [
                sum(outreach_exo),
                sum(health_post_exo),
                sum(seminar_exo),
                sum(training_exo),
            ]
            fv_data = [
                sum(outreach_fv),
                sum(health_post_fv),
                sum(seminar_fv),
                sum(training_fv),
            ]
            art_data = [
                sum(outreach_art),
                sum(health_post_art),
                sum(seminar_art),
                sum(training_art),
            ]
            seal_data = [
                sum(outreach_seal),
                sum(health_post_seal),
                sum(seminar_seal),
                sum(training_seal),
            ]
            sdf_data = [
                sum(outreach_sdf),
                sum(health_post_sdf),
                sum(seminar_sdf),
                sum(training_sdf),
            ]

            exo_data1 = [
                sum(kid_exo),
                sum(teen_exo),
                sum(adult_exo),
                sum(old_adult_exo),
            ]
            art_data1 = [
                sum(kid_art),
                sum(teen_art),
                sum(adult_art),
                sum(old_adult_art),
            ]
            seal_data1 = [
                sum(kid_seal),
                sum(teen_seal),
                sum(adult_seal),
                sum(old_adult_seal),
            ]
            sdf_data1 = [
                sum(kid_sdf),
                sum(teen_sdf),
                sum(adult_sdf),
                sum(old_adult_sdf),
            ]
            fv_data1 = [
                sum(kid_fv), 
                sum(teen_fv), 
                sum(adult_fv), 
                sum(old_adult_fv)
                ]
            if age_group_activity == "Age Group":
                locationChart = {
                    "data": {
                        "labels": district1,
                        "datasets": [
                            {
                                "label": "EXO",
                                "backgroundColor": "rgba(255, 206, 86, 0.2)",
                                "borderColor": "rgba(255, 206, 86, 1)",
                                "borderWidth": 1,
                                "data": exo_data1,
                            },
                            {
                                "label": "ART",
                                "backgroundColor": "rgba(81, 264, 289, 0.2)",
                                "borderColor": "rgba(81, 264, 210, 1)",
                                "borderWidth": 1,
                                "data": art_data1,
                            },
                            {
                                "label": "SEAL",
                                "backgroundColor": "rgba(16, 152, 247, 0.2)",
                                "borderColor": "rgba(16, 152, 247, 1)",
                                "borderWidth": 1,
                                "data": seal_data1,
                            },
                            {
                                "label": "SDF",
                                "backgroundColor": "rgba(87, 50, 200, 0.2)",
                                "borderColor": "rgba(87, 50, 200, 1)",
                                "borderWidth": 1,
                                "data": sdf_data1,
                            },
                            {
                                "label": "FV",
                                "backgroundColor": "rgba(239, 62, 54, 0.2)",
                                "borderColor": "rgba(239, 62, 54, 1)",
                                "borderWidth": 1,
                                "data": fv_data1,
                            },
                            
                            
                        ],
                    },
                    "options": {
                        "aspectRatio": 1.5,
                        "scales": {"yAxes": [{"ticks": {"beginAtZero": "true"}}]},
                        "title": {
                            "display": "true",
                            # 'text': "Setting-wise treatment distribution",
                            "fontSize": 18,
                            "fontFamily": "'Palanquin', sans-serif",
                        },
                        "legend": {
                            "display": "true",
                            "position": "bottom",
                            "labels": {
                                "usePointStyle": "true",
                                "padding": 20,
                                "fontFamily": "'Maven Pro', sans-serif",
                            },
                        },
                    },
                }
            else:
                locationChart = {
                    "data": {
                        "labels": district,
                        "datasets": [
                            {
                                "label": "EXO",
                                "backgroundColor": "rgba(255, 206, 86, 0.2)",
                                "borderColor": "rgba(255, 206, 86, 1)",
                                "borderWidth": 1,
                                "data": exo_data,
                            },
                            {
                                "label": "ART",
                                "backgroundColor": "rgba(81, 264, 289, 0.2)",
                                "borderColor": "rgba(81, 264, 210, 1)",
                                "borderWidth": 1,
                                "data": art_data,
                            },
                            {
                                "label": "SEAL",
                                "backgroundColor": "rgba(16, 152, 247, 0.2)",
                                "borderColor": "rgba(16, 152, 247, 1)",
                                "borderWidth": 1,
                                "data": seal_data,
                            },
                            {
                                "label": "SDF",
                                "backgroundColor": "rgba(87, 50, 200, 0.2)",
                                "borderColor": "rgba(87, 50, 200, 1)",
                                "borderWidth": 1,
                                "data": sdf_data,
                            },
                            {
                                "label": "FV",
                                "backgroundColor": "rgba(239, 62, 54, 0.2)",
                                "borderColor": "rgba(239, 62, 54, 1)",
                                "borderWidth": 1,
                                "data": fv_data,
                            },
                        ],
                    },
                    "options": {
                        "aspectRatio": 1.5,
                        "scales": {"yAxes": [{"ticks": {"beginAtZero": "true"}}]},
                        "title": {
                            "display": "true",
                            # 'text': "Setting-wise treatment distribution",
                            "fontSize": 18,
                            "fontFamily": "'Palanquin', sans-serif",
                        },
                        "legend": {
                            "display": "true",
                            "position": "bottom",
                            "labels": {
                                "usePointStyle": "true",
                                "padding": 20,
                                "fontFamily": "'Maven Pro', sans-serif",
                            },
                        },
                    },
                }
            return Response({"locationChart": locationChart}, status=200)
        return Response({"message": serializer.errors}, status=400)


# 1.3 Activity Distribution
class ActivityDistributionAPI(APIView):
    permission_classes = (IsPostOrIsAuthenticated,)
    serializer_class = ActivityDistributionVisualization

    def get(self, request, format=None):
        data = []
        data_label = []
        for activities_obj in Activity.objects.all():
            data_label.append(activities_obj.name)
            a = []
            if (
                Visualization.objects.filter(active=True,
                    created_at__range=[last_30_days_obj, today_date_obj],
                    activities_id=activities_obj.id,
                ).aggregate(Sum("exo"))["exo__sum"]
                is not None
            ):
                a.append(
                    Visualization.objects.filter(active=True,
                        created_at__range=[last_30_days_obj, today_date_obj],
                        activities_id=activities_obj.id,
                    ).aggregate(Sum("exo"))["exo__sum"]
                )
            else:
                a.append(0)

            if (
                Visualization.objects.filter(active=True,
                    created_at__range=[last_30_days_obj, today_date_obj],
                    activities_id=activities_obj.id,
                ).aggregate(Sum("art"))["art__sum"]
                is not None
            ):
                a.append(
                    Visualization.objects.filter(active=True,
                        created_at__range=[last_30_days_obj, today_date_obj],
                        activities_id=activities_obj.id,
                    ).aggregate(Sum("art"))["art__sum"]
                )
            else:
                a.append(0)

            if (
                Visualization.objects.filter(active=True,
                    created_at__range=[last_30_days_obj, today_date_obj],
                    activities_id=activities_obj.id,
                ).aggregate(Sum("seal"))["seal__sum"]
                is not None
            ):
                a.append(
                    Visualization.objects.filter(active=True,
                        created_at__range=[last_30_days_obj, today_date_obj],
                        activities_id=activities_obj.id,
                    ).aggregate(Sum("seal"))["seal__sum"]
                )
            else:
                a.append(0)

            if (
                Visualization.objects.filter(active=True,
                    created_at__range=[last_30_days_obj, today_date_obj],
                    activities_id=activities_obj.id,
                ).aggregate(Sum("sdf"))["sdf__sum"]
                is not None
            ):
                a.append(
                    Visualization.objects.filter(active=True,
                        created_at__range=[last_30_days_obj, today_date_obj],
                        activities_id=activities_obj.id,
                    ).aggregate(Sum("sdf"))["sdf__sum"]
                )
            else:
                a.append(0)
            a.append(
                Visualization.objects.filter(active=True,
                    fv=True,
                    created_at__range=[last_30_days_obj, today_date_obj],
                    activities_id=activities_obj.id,
                ).count()
            )
            data.append(sum(a))
        locationChart = {
            "data": {
                "labels": data_label,
                "datasets": [
                    {
                        "label": "Female",
                        "backgroundColor": [
                            "rgba(84, 184, 209, 0.5)",
                            "rgba(91, 95, 151, 0.5)",
                            "rgba(255, 193, 69, 0.5)",
                            "rgba(96, 153, 45, 0.5)",
                            "rgba(230, 232, 230, 0.5)",
                        ],
                        "borderColor": [
                            "rgba(84, 184, 209, 1)",
                            "rgba(91, 95, 151, 1)",
                            "rgba(255, 193, 69, 1)",
                            "rgba(96, 153, 45, 1)",
                            "rgba(230, 232, 230, 1)",
                        ],
                        "borderWidth": 1,
                        "data": data,
                    }
                ],
            },
            "options": {
                "aspectRatio": 1.5,
                "title": {
                    "display": "true",
                    # 'text': "Activity Distribution Chart",
                    "fontSize": 18,
                    "fontFamily": "'Palanquin', sans-serif",
                },
                "legend": {
                    "display": "true",
                    "position": "bottom",
                    "labels": {
                        "usePointStyle": "true",
                        "padding": 20,
                        "fontFamily": "'Maven Pro', sans-serif",
                    },
                },
            },
        }
        return Response({"locationChart": locationChart})

    def post(self, request, format=None):
        serializer = TreatMentBarGraphVisualization(
            data=request.data, context={"request": request}
        )
        if serializer.is_valid():
            # start_date = str(NepaliDate.from_date(serializer.validated_data["start_date"]))
            # end_date = str(NepaliDate.from_date(serializer.validated_data["end_date"]))
            locationChart = []
            start_date = serializer.validated_data["start_date"]
            end_date = serializer.validated_data["end_date"]

            print("Heyyyyyyyyyyyy")
            print(start_date)
            print(end_date)

            treatment_type = serializer.validated_data["treatment_type"]
            location_list = serializer.validated_data["location"]

            data_label = []

            if treatment_type == "alltreatment":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        if (
                            Visualization.objects.filter(active=True,
                                created_at__range=[start_date, end_date],
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                            ).aggregate(Sum("exo"))["exo__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    created_at__range=[start_date, end_date],
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                ).aggregate(Sum("exo"))["exo__sum"]
                            )
                        else:
                            a.append(0)

                        if (
                            Visualization.objects.filter(active=True,
                                created_at__range=[start_date, end_date],
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                            ).aggregate(Sum("art"))["art__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    created_at__range=[start_date, end_date],
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                ).aggregate(Sum("art"))["art__sum"]
                            )
                        else:
                            a.append(0)

                        if (
                            Visualization.objects.filter(active=True,
                                created_at__range=[start_date, end_date],
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                            ).aggregate(Sum("seal"))["seal__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    created_at__range=[start_date, end_date],
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                ).aggregate(Sum("seal"))["seal__sum"]
                            )
                        else:
                            a.append(0)

                        if (
                            Visualization.objects.filter(active=True,
                                created_at__range=[start_date, end_date],
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                            ).aggregate(Sum("sdf"))["sdf__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    created_at__range=[start_date, end_date],
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                ).aggregate(Sum("sdf"))["sdf__sum"]
                            )
                        else:
                            a.append(0)

                        a.append(
                            Visualization.objects.filter(active=True,
                                fv=True,
                                created_at__range=[start_date, end_date],
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                            ).count()
                        )
                    print(a)
                    data.append(sum(a))
                    a = []

            if treatment_type == "exo":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        if (
                            Visualization.objects.filter(active=True,
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                                created_at__range=[start_date, end_date],
                            ).aggregate(Sum("exo"))["exo__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                    created_at__range=[start_date, end_date],
                                ).aggregate(Sum("exo"))["exo__sum"]
                            )
                        else:
                            a.append(0)
                    data.append(sum(a))
                    a = []

            if treatment_type == "art":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        if (
                            Visualization.objects.filter(active=True,
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                                created_at__range=[start_date, end_date],
                            ).aggregate(Sum("art"))["art__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                    created_at__range=[start_date, end_date],
                                ).aggregate(Sum("art"))["art__sum"]
                            )
                        else:
                            a.append(0)
                    data.append(sum(a))
                    a = []

            if treatment_type == "seal":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        if (
                            Visualization.objects.filter(active=True,
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                                created_at__range=[start_date, end_date],
                            ).aggregate(Sum("seal"))["seal__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                    created_at__range=[start_date, end_date],
                                ).aggregate(Sum("seal"))["seal__sum"]
                            )
                        else:
                            a.append(0)
                    data.append(sum(a))
                    a = []

            if treatment_type == "sdf":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        if (
                            Visualization.objects.filter(active=True,
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                                created_at__range=[start_date, end_date],
                            ).aggregate(Sum("sdf"))["sdf__sum"]
                            is not None
                        ):
                            a.append(
                                Visualization.objects.filter(active=True,
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                    created_at__range=[start_date, end_date],
                                ).aggregate(Sum("sdf"))["sdf__sum"]
                            )
                        else:
                            a.append(0)
                    data.append(sum(a))
                    a = []

            if treatment_type == "fv":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        a.append(
                            Visualization.objects.filter(active=True,
                                fv=True,
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                                created_at__range=[start_date, end_date],
                            ).count()
                        )
                    data.append(sum(a))
                    a = []
                
            if treatment_type == "f-sdf":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        a.append(
                            Visualization.objects.filter(active=True,
                                sdf_whole_mouth=True,
                                activities_id=activities_obj.id,
                                geography_id=location.id,
                                created_at__range=[start_date, end_date],
                            ).count()
                        )
                    data.append(sum(a))
                    a = []
                
            if treatment_type == "contacts":
                data = []
                for activities_obj in Activity.objects.all():
                    data_label.append(activities_obj.name)
                    a = []
                    for location in location_list:
                        a.append(
                                Visualization.objects.filter(active=True,
                                    activities_id=activities_obj.id,
                                    geography_id=location.id,
                                    created_at__range=[start_date, end_date],
                                ).count()
                            )
                    data.append(sum(a))
                    a = []
                                
            locationChart = {
                "data": {
                    "labels": data_label,
                    "datasets": [
                        {
                            "label": "Female",
                            "backgroundColor": [
                                "rgba(255, 206, 86, 0.5)",
                                "rgba(239, 62, 54, 0.5)",
                                "rgba(81, 264, 210, 0.5)",
                                "rgba(16, 152, 247, 0.5)",
                            ],
                            "borderColor": [
                                "rgba(255, 206, 86, 0.5)",
                                "rgba(239, 62, 54, 1)",
                                "rgba(81, 264, 210, 1)",
                                "rgba(16, 152, 247, 1)",
                            ],
                            "borderWidth": 1,
                            "data": data,
                        }
                    ],
                },
                "options": {
                    "aspectRatio": 1.5,
                    "title": {
                        "display": "true",
                        # 'text': "Activity Distribution Chart",
                        "fontSize": 18,
                        "fontFamily": "'Palanquin', sans-serif",
                    },
                    "legend": {
                        "display": "true",
                        "position": "bottom",
                        "labels": {
                            "usePointStyle": "true",
                            "padding": 20,
                            "fontFamily": "'Maven Pro', sans-serif",
                        },
                    },
                },
            }
        return Response({"locationChart": locationChart})
